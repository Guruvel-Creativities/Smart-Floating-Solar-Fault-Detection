<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ESP32 Solar Monitor</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#0b0f1a;color:white;font-family:Segoe UI;margin:0;}
.header{background:#11182b;padding:18px;text-align:center;font-size:26px;font-weight:bold;}
.status{text-align:center;padding:6px;background:#7a1d1d;font-size:13px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;padding:20px;}
.card{background:#151c30;padding:20px;border-radius:14px;box-shadow:0 5px 25px rgba(0,0,0,0.6);}
.big{font-size:34px;margin:10px 0;font-weight:bold;color:#8ab4f8;}
.value-row{display:flex;justify-content:space-between;margin:10px 0;padding:8px;background:#1e2740;border-radius:8px;}

/* Toggle Switch */
.switch{position:relative;display:inline-block;width:70px;height:36px;}
.switch input{display:none;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#888;border-radius:34px;}
.slider:before{position:absolute;content:"";height:28px;width:28px;left:4px;bottom:4px;background:white;border-radius:50%;transition:.3s;}
input:checked + .slider{background:#00c853;}
input:checked + .slider:before{transform:translateX(34px);}

.btn{background:#2a3a5e;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-right:10px;}
.btn-reset{background:#b95b0d;}
.fault-NORMAL{color:#00c853; font-weight:bold;}
.fault-LOW{color:#f9a825; font-weight:bold;}
.fault-CRITICAL{color:#ff6b6b; font-weight:bold;}
canvas{width:100% !important;height:250px !important;background:#1e2740;border-radius:10px;}
</style>
</head>

<body>
<div class="header">ğŸ”‹ ESP32 Solar Monitor</div>
<div id="statusBar" class="status">CONNECTING...</div>

<div class="grid">
  <!-- Relay Control Card - SIMPLIFIED -->
  <div class="card">
    <h3>âš¡ Relay Control</h3>
    <div class="value-row">
      <span>Manual Switch:</span>
      <label class="switch">
        <input type="checkbox" id="relaySwitch" onchange="toggleRelay(this)">
        <span class="slider"></span>
      </label>
    </div>
    <div class="value-row">
      <span>Current State:</span>
      <span id="relayStateDisplay">OFF</span>
    </div>
    <div class="value-row">
      <button class="btn" onclick="setRelay(true)">ğŸ”˜ TURN ON</button>
      <button class="btn" onclick="setRelay(false)">ğŸ”˜ TURN OFF</button>
      <button class="btn btn-reset" onclick="resetSystem()">ğŸ”„ RESET</button>
    </div>
    <div id="commandMsg" style="color:#00c853; font-size:12px; margin-top:5px;"></div>
  </div>

  <!-- Battery Card -->
  <div class="card">
    <h3>ğŸ”‹ Battery</h3>
    <div id="batteryValue" class="big">--.-- V</div>
    <div id="batteryPercent">--%</div>
    <div id="faultStatus" class="fault-NORMAL">NORMAL</div>
  </div>

  <!-- Solar Card -->
  <div class="card">
    <h3>â˜€ï¸ Solar Panel</h3>
    <div id="solarValue" class="big">--.-- V</div>
    <div id="solarCondition">--</div>
  </div>

  <!-- Charts -->
  <div class="card">
    <h3>ğŸ“Š Battery History</h3>
    <canvas id="batteryChart"></canvas>
  </div>
  <div class="card">
    <h3>ğŸ“Š Solar History</h3>
    <canvas id="solarChart"></canvas>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCkmuTiwSxHQ6_gKjpqYS357MlCLM9rp1k",
  authDomain: "solar-fault-detection-ecf01.firebaseapp.com",
  databaseURL: "https://solar-fault-detection-ecf01-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "solar-fault-detection-ecf01",
  storageBucket: "solar-fault-detection-ecf01.firebasestorage.app",
  messagingSenderId: "370792337840",
  appId: "1:370792337840:web:9619f4b0be5c435f750675"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const solarRef = db.ref("solar_system");

// Connection status
db.ref(".info/connected").on("value", (snap) => {
  const statusEl = document.getElementById("statusBar");
  if (snap.val()) {
    statusEl.innerHTML = "âœ… CONNECTED TO FIREBASE";
    statusEl.style.background = "#0a7e3a";
  } else {
    statusEl.innerHTML = "âŒ DISCONNECTED";
    statusEl.style.background = "#7a1d1d";
  }
});

// Charts
let batteryHistory = [];
let solarHistory = [];
let timeLabels = [];

const batteryChart = new Chart(document.getElementById("batteryChart"), {
  type: 'line',
  data: { labels: timeLabels, datasets: [{ label: 'Battery (V)', data: batteryHistory, borderColor: '#8ab4f8' }] },
  options: { scales: { y: { max: 15, min: 10 } } }
});

const solarChart = new Chart(document.getElementById("solarChart"), {
  type: 'line',
  data: { labels: timeLabels, datasets: [{ label: 'Solar (V)', data: solarHistory, borderColor: '#f9a825' }] },
  options: { scales: { y: { max: 20, min: 0 } } }
});

// Listen for data from ESP32
solarRef.on("value", (snapshot) => {
  const data = snapshot.val();
  if (!data) return;
  
  // Update battery
  const batteryVoltage = data.battery_voltage || 0;
  document.getElementById("batteryValue").innerHTML = batteryVoltage.toFixed(2) + " V";
  
  // Calculate battery percent (11V-12.6V range)
  const percent = Math.min(100, Math.max(0, ((batteryVoltage - 11) / 1.6) * 100));
  document.getElementById("batteryPercent").innerHTML = percent.toFixed(0) + "%";
  
  // Update solar
  const solarVoltage = data.solar_voltage || 0;
  document.getElementById("solarValue").innerHTML = solarVoltage.toFixed(2) + " V";
  
  // Solar condition
  let solarCondition = "Night";
  if (solarVoltage > 12) solarCondition = "â˜€ï¸ Strong";
  else if (solarVoltage > 5) solarCondition = "â›… Weak";
  else if (solarVoltage > 1) solarCondition = "ğŸŒ™ Dawn/Dusk";
  document.getElementById("solarCondition").innerHTML = solarCondition;
  
  // Update relay state (SINGLE FIELD)
  const relayState = data.relay_state || false;
  document.getElementById("relaySwitch").checked = relayState;
  document.getElementById("relayStateDisplay").innerHTML = relayState ? "ON" : "OFF";
  document.getElementById("relayStateDisplay").style.color = relayState ? "#00c853" : "#ff6b6b";
  
  // Update fault
  const faultMsg = data.fault_status || "NORMAL";
  const faultEl = document.getElementById("faultStatus");
  faultEl.innerHTML = faultMsg;
  faultEl.className = faultMsg.includes("LOW") ? "fault-LOW" : 
                     (faultMsg.includes("OVER") ? "fault-CRITICAL" : "fault-NORMAL");
  
  // Update charts
  const time = new Date().toLocaleTimeString();
  timeLabels.push(time);
  batteryHistory.push(batteryVoltage);
  solarHistory.push(solarVoltage);
  
  if (timeLabels.length > 20) {
    timeLabels.shift();
    batteryHistory.shift();
    solarHistory.shift();
  }
  
  batteryChart.update();
  solarChart.update();
});

// ===== RELAY CONTROL FUNCTIONS =====
// This uses the SINGLE relay_state field

function toggleRelay(switchEl) {
  const newState = switchEl.checked;
  setRelay(newState);
}

function setRelay(state) {
  // Update the SINGLE relay field in Firebase
  solarRef.update({
    relay_state: state
  }).then(() => {
    document.getElementById("commandMsg").innerHTML = "âœ“ Relay command sent";
    setTimeout(() => document.getElementById("commandMsg").innerHTML = "", 2000);
  }).catch(error => {
    document.getElementById("commandMsg").innerHTML = "âœ— Error: " + error.message;
  });
}

function resetSystem() {
  if (confirm("Reset system? Relay will turn OFF")) {
    // Set reset flag AND turn relay off
    solarRef.update({
      reset: true,
      relay_state: false
    }).then(() => {
      document.getElementById("commandMsg").innerHTML = "âœ“ Reset command sent";
      document.getElementById("relaySwitch").checked = false;
      setTimeout(() => {
        // Clear reset flag after 2 seconds
        solarRef.update({ reset: false });
      }, 2000);
    });
  }
}
</script>
</body>
</html>
