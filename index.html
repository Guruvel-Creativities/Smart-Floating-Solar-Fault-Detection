<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ESP32 Solar Monitor</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#0b0f1a;color:white;font-family:Segoe UI;margin:0;}
.header{background:#11182b;padding:18px;text-align:center;font-size:26px;font-weight:bold;}
.status{text-align:center;padding:6px;background:#7a1d1d;font-size:13px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;padding:20px;}
.card{background:#151c30;padding:20px;border-radius:14px;box-shadow:0 5px 25px rgba(0,0,0,0.6);}
.big{font-size:34px;margin:10px 0;font-weight:bold;color:#8ab4f8;}
.value-row{display:flex;justify-content:space-between;margin:10px 0;padding:8px;background:#1e2740;border-radius:8px;}

/* Toggle Switch */
.switch{position:relative;display:inline-block;width:70px;height:36px;}
.switch input{display:none;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#888;border-radius:34px;}
.slider:before{position:absolute;content:"";height:28px;width:28px;left:4px;bottom:4px;background:white;border-radius:50%;transition:.3s;}
input:checked + .slider{background:#00c853;}
input:checked + .slider:before{transform:translateX(34px);}

.btn{background:#2a3a5e;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-right:10px;}
.btn:hover{background:#3a4a7e;}
.btn-reset{background:#b95b0d;}
.btn-reset:hover{background:#d97b2d;}
.fault-NORMAL{color:#00c853; font-weight:bold;}
.fault-LOW{color:#f9a825; font-weight:bold;}
.fault-CRITICAL{color:#ff6b6b; font-weight:bold;}
.chart-container{position:relative; height:300px; width:100%; background:#1e2740; border-radius:10px; padding:10px;}
.tooltip-custom{
  background:#11182b;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #2a3a5e;
  box-shadow:0 4px 15px rgba(0,0,0,0.5);
  font-size:12px;
  pointer-events:none;
  z-index:1000;
}
</style>
</head>

<body>
<div class="header">ğŸ”‹ ESP32 Solar Monitor</div>
<div id="statusBar" class="status">CONNECTING...</div>

<div class="grid">
  <!-- Relay Control Card -->
  <div class="card">
    <h3>âš¡ Relay Control</h3>
    <div class="value-row">
      <span>Manual Switch:</span>
      <label class="switch">
        <input type="checkbox" id="relaySwitch" onchange="toggleRelay(this)">
        <span class="slider"></span>
      </label>
    </div>
    <div class="value-row">
      <span>Current State:</span>
      <span id="relayStateDisplay">OFF</span>
    </div>
    <div class="value-row">
      <button class="btn" onclick="setRelay(true)">ğŸ”˜ TURN ON</button>
      <button class="btn" onclick="setRelay(false)">ğŸ”˜ TURN OFF</button>
      <button class="btn btn-reset" onclick="resetSystem()">ğŸ”„ RESET</button>
    </div>
    <div id="commandMsg" style="color:#00c853; font-size:12px; margin-top:5px;"></div>
  </div>

  <!-- Battery Card -->
  <div class="card">
    <h3>ğŸ”‹ Battery</h3>
    <div id="batteryValue" class="big">--.-- V</div>
    <div id="batteryPercent">--%</div>
    <div id="faultStatus" class="fault-NORMAL">NORMAL</div>
  </div>

  <!-- Solar Card -->
  <div class="card">
    <h3>â˜€ï¸ Solar Panel</h3>
    <div id="solarValue" class="big">--.-- V</div>
    <div id="solarCondition">--</div>
  </div>

  <!-- COMBINED GRAPH - Both Battery and Solar in one -->
  <div class="card" style="grid-column: 1 / -1;">
    <h3>ğŸ“Š Battery & Solar History (Combined)</h3>
    <div class="chart-container">
      <canvas id="combinedChart"></canvas>
    </div>
    <div style="display:flex; justify-content:center; gap:30px; margin-top:10px;">
      <div><span style="color:#8ab4f8;">â—</span> Battery (V)</div>
      <div><span style="color:#f9a825;">â—</span> Solar (V)</div>
    </div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCkmuTiwSxHQ6_gKjpqYS357MlCLM9rp1k",
  authDomain: "solar-fault-detection-ecf01.firebaseapp.com",
  databaseURL: "https://solar-fault-detection-ecf01-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "solar-fault-detection-ecf01",
  storageBucket: "solar-fault-detection-ecf01.firebasestorage.app",
  messagingSenderId: "370792337840",
  appId: "1:370792337840:web:9619f4b0be5c435f750675"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const solarRef = db.ref("solar_system");

// Connection status
db.ref(".info/connected").on("value", (snap) => {
  const statusEl = document.getElementById("statusBar");
  if (snap.val()) {
    statusEl.innerHTML = "âœ… CONNECTED TO FIREBASE";
    statusEl.style.background = "#0a7e3a";
  } else {
    statusEl.innerHTML = "âŒ DISCONNECTED";
    statusEl.style.background = "#7a1d1d";
  }
});

// Combined Chart with tooltips
let timeLabels = [];
let batteryData = [];
let solarData = [];

const ctx = document.getElementById("combinedChart").getContext("2d");

const combinedChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: timeLabels,
    datasets: [
      {
        label: 'Battery Voltage (V)',
        data: batteryData,
        borderColor: '#8ab4f8',
        backgroundColor: 'rgba(138, 180, 248, 0.1)',
        borderWidth: 2,
        tension: 0.4,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 8,
        pointBackgroundColor: '#8ab4f8',
        pointBorderColor: 'white',
        pointHoverBackgroundColor: 'white',
        pointHoverBorderColor: '#8ab4f8',
        yAxisID: 'y'
      },
      {
        label: 'Solar Voltage (V)',
        data: solarData,
        borderColor: '#f9a825',
        backgroundColor: 'rgba(249, 168, 37, 0.1)',
        borderWidth: 2,
        tension: 0.4,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 8,
        pointBackgroundColor: '#f9a825',
        pointBorderColor: 'white',
        pointHoverBackgroundColor: 'white',
        pointHoverBorderColor: '#f9a825',
        yAxisID: 'y'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
      mode: 'index',
      intersect: false,
    },
    plugins: {
      tooltip: {
        enabled: true,
        mode: 'index',
        intersect: false,
        backgroundColor: '#11182b',
        titleColor: 'white',
        bodyColor: '#ddd',
        borderColor: '#2a3a5e',
        borderWidth: 1,
        padding: 10,
        displayColors: true,
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';
            if (label) {
              label += ': ';
            }
            if (context.parsed.y !== null) {
              label += context.parsed.y.toFixed(2) + ' V';
            }
            return label;
          },
          afterLabel: function(context) {
            // Add time to tooltip
            const timeLabel = context.label;
            return 'Time: ' + timeLabel;
          }
        }
      },
      legend: {
        display: false
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        max: 20,
        grid: { color: '#2a3a5e' },
        ticks: { 
          color: 'white',
          callback: function(value) {
            return value + ' V';
          }
        },
        title: {
          display: true,
          text: 'Voltage (V)',
          color: 'white'
        }
      },
      x: {
        grid: { color: '#2a3a5e' },
        ticks: { 
          color: 'white',
          maxRotation: 45,
          minRotation: 45,
          maxTicksLimit: 8
        }
      }
    }
  }
});

// Listen for data from ESP32
solarRef.on("value", (snapshot) => {
  const data = snapshot.val();
  if (!data) return;
  
  // Update battery
  const batteryVoltage = data.battery_voltage || 0;
  document.getElementById("batteryValue").innerHTML = batteryVoltage.toFixed(2) + " V";
  
  // Calculate battery percent (11V-12.6V range)
  const percent = Math.min(100, Math.max(0, ((batteryVoltage - 11) / 1.6) * 100));
  document.getElementById("batteryPercent").innerHTML = percent.toFixed(0) + "%";
  
  // Update solar
  const solarVoltage = data.solar_voltage || 0;
  document.getElementById("solarValue").innerHTML = solarVoltage.toFixed(2) + " V";
  
  // Solar condition
  let solarCondition = "Night";
  if (solarVoltage > 12) solarCondition = "â˜€ï¸ Strong";
  else if (solarVoltage > 5) solarCondition = "â›… Weak";
  else if (solarVoltage > 1) solarCondition = "ğŸŒ™ Dawn/Dusk";
  document.getElementById("solarCondition").innerHTML = solarCondition;
  
  // Update relay state
  const relayState = data.relay_state || false;
  document.getElementById("relaySwitch").checked = relayState;
  document.getElementById("relayStateDisplay").innerHTML = relayState ? "ON" : "OFF";
  document.getElementById("relayStateDisplay").style.color = relayState ? "#00c853" : "#ff6b6b";
  
  // Update fault
  const faultMsg = data.fault_status || "NORMAL";
  const faultEl = document.getElementById("faultStatus");
  faultEl.innerHTML = faultMsg;
  faultEl.className = faultMsg.includes("LOW") ? "fault-LOW" : 
                     (faultMsg.includes("OVER") ? "fault-CRITICAL" : "fault-NORMAL");
  
  // Update combined chart
  const time = new Date().toLocaleTimeString();
  timeLabels.push(time);
  batteryData.push(batteryVoltage);
  solarData.push(solarVoltage);
  
  // Keep last 15 points for better visibility
  if (timeLabels.length > 15) {
    timeLabels.shift();
    batteryData.shift();
    solarData.shift();
  }
  
  combinedChart.update();
});

// ===== RELAY CONTROL FUNCTIONS =====
function toggleRelay(switchEl) {
  const newState = switchEl.checked;
  setRelay(newState);
}

function setRelay(state) {
  solarRef.update({
    relay_state: state
  }).then(() => {
    document.getElementById("commandMsg").innerHTML = "âœ“ Relay command sent";
    setTimeout(() => document.getElementById("commandMsg").innerHTML = "", 2000);
  }).catch(error => {
    document.getElementById("commandMsg").innerHTML = "âœ— Error: " + error.message;
  });
}

function resetSystem() {
  if (confirm("Reset system? Relay will turn OFF")) {
    solarRef.update({
      reset: true,
      relay_state: false
    }).then(() => {
      document.getElementById("commandMsg").innerHTML = "âœ“ Reset command sent";
      document.getElementById("relaySwitch").checked = false;
      setTimeout(() => {
        solarRef.update({ reset: false });
      }, 2000);
    });
  }
}
</script>
</body>
</html>
