<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ESP32 Solar Water Filtering System</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#0b0f1a;color:white;font-family:Segoe UI;margin:0;}
.header{background:#11182b;padding:18px;text-align:center;font-size:26px;font-weight:bold; border-bottom: 2px solid #2a6df4;}
.status{text-align:center;padding:6px;background:#7a1d1d;font-size:13px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;padding:20px;}
.card{background:#151c30;padding:20px;border-radius:14px;box-shadow:0 5px 25px rgba(0,0,0,0.6); border-left: 4px solid #2a6df4;}
.big{font-size:34px;margin:10px 0;font-weight:bold;color:#8ab4f8;}
.value-row{display:flex;justify-content:space-between;margin:10px 0;padding:8px;background:#1e2740;border-radius:8px;}

/* Toggle Switch */
.switch{position:relative;display:inline-block;width:70px;height:36px;}
.switch input{display:none;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#888;border-radius:34px;}
.slider:before{position:absolute;content:"";height:28px;width:28px;left:4px;bottom:4px;background:white;border-radius:50%;transition:.3s;}
input:checked + .slider{background:#00c853;}
input:checked + .slider:before{transform:translateX(34px);}

.btn{background:#2a6df4;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-right:10px; font-weight:bold;}
.btn:hover{background:#4a8df4;}
.btn-off{background:#7a1d1d;}
.btn-off:hover{background:#9a3d3d;}
.fault-NORMAL{color:#00c853; font-weight:bold;}
.fault-LOW{color:#f9a825; font-weight:bold;}
.fault-CRITICAL{color:#ff6b6b; font-weight:bold;}
.chart-container{position:relative; height:300px; width:100%; background:#1e2740; border-radius:10px; padding:10px;}
.pump-icon{font-size: 24px; margin-right: 10px; vertical-align: middle;}
.water-icon{font-size: 20px; margin-right: 5px;}
</style>
</head>

<body>
<div class="header">ğŸ’§ ESP32 Solar Water Filtering System ğŸŒŠ</div>
<div id="statusBar" class="status">CONNECTING...</div>

<div class="grid">
  <!-- Filter Pump Control Card -->
  <div class="card">
    <h3><span class="pump-icon">â›²</span> Water Filter Pump Control</h3>
    <div class="value-row">
      <span><span class="water-icon">ğŸ’§</span> Pump Switch:</span>
      <label class="switch">
        <input type="checkbox" id="relaySwitch" onchange="toggleRelay(this)">
        <span class="slider"></span>
      </label>
    </div>
    <div class="value-row">
      <span><span class="water-icon">âš¡</span> Pump Status:</span>
      <span id="relayStateDisplay" style="font-weight:bold;">OFF</span>
    </div>
    <div class="value-row">
      <span><span class="water-icon">ğŸ”„</span> Operating Mode:</span>
      <span id="pumpMode">Manual</span>
    </div>
    <div class="value-row" style="justify-content: center; gap: 10px;">
      <button class="btn" onclick="setRelay(true)">ğŸ’§ START FILTER</button>
      <button class="btn btn-off" onclick="setRelay(false)">â¹ï¸ STOP FILTER</button>
    </div>
    <div id="commandMsg" style="color:#00c853; font-size:12px; margin-top:5px; text-align:center;"></div>
  </div>

  <!-- Battery Card - REMOVED PERCENT -->
  <div class="card">
    <h3>ğŸ”‹ Battery Voltage</h3>
    <div id="batteryValue" class="big">--.-- V</div>
    <div id="faultStatus" class="fault-NORMAL">NORMAL</div>
  </div>

  <!-- Solar Card - REMOVED WATT -->
  <div class="card">
    <h3>â˜€ï¸ Solar Panel Voltage</h3>
    <div id="solarValue" class="big">--.-- V</div>
    <div id="solarCondition">--</div>
  </div>

  <!-- Pump Status Card -->
  <div class="card">
    <h3>â›² Filter Pump Information</h3>
    <div class="value-row">
      <span><span class="water-icon">â±ï¸</span> Runtime Today:</span>
      <span id="pumpRuntime">0 min</span>
    </div>
    <div class="value-row">
      <span><span class="water-icon">ğŸ”„</span> Cycles Today:</span>
      <span id="pumpCycles">0</span>
    </div>
    <div class="value-row">
      <span><span class="water-icon">â°</span> Last Started:</span>
      <span id="pumpLastStart">--:--</span>
    </div>
  </div>

  <!-- COMBINED GRAPH -->
  <div class="card" style="grid-column: 1 / -1;">
    <h3>ğŸ“Š System Performance - Battery & Solar</h3>
    <div class="chart-container">
      <canvas id="combinedChart"></canvas>
    </div>
    <div style="display:flex; justify-content:center; gap:30px; margin-top:15px;">
      <div><span style="color:#8ab4f8;">â—</span> Battery Voltage (V)</div>
      <div><span style="color:#f9a825;">â—</span> Solar Voltage (V)</div>
      <div><span style="color:#00c853;" id="pumpIndicator">â—</span> <span id="pumpIndicatorText">Pump OFF</span></div>
    </div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCkmuTiwSxHQ6_gKjpqYS357MlCLM9rp1k",
  authDomain: "solar-fault-detection-ecf01.firebaseapp.com",
  databaseURL: "https://solar-fault-detection-ecf01-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "solar-fault-detection-ecf01",
  storageBucket: "solar-fault-detection-ecf01.firebasestorage.app",
  messagingSenderId: "370792337840",
  appId: "1:370792337840:web:9619f4b0be5c435f750675"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const solarRef = db.ref("solar_system");

// Pump tracking variables
let pumpStartTime = null;
let totalRuntime = 0;
let pumpCycles = 0;
let lastPumpState = false;

// Connection status
db.ref(".info/connected").on("value", (snap) => {
  const statusEl = document.getElementById("statusBar");
  if (snap.val()) {
    statusEl.innerHTML = "âœ… CONNECTED TO SYSTEM";
    statusEl.style.background = "#0a7e3a";
  } else {
    statusEl.innerHTML = "âŒ DISCONNECTED";
    statusEl.style.background = "#7a1d1d";
  }
});

// Combined Chart
let timeLabels = [];
let batteryData = [];
let solarData = [];

const ctx = document.getElementById("combinedChart").getContext("2d");

const combinedChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: timeLabels,
    datasets: [
      {
        label: 'Battery Voltage (V)',
        data: batteryData,
        borderColor: '#8ab4f8',
        backgroundColor: 'rgba(138, 180, 248, 0.1)',
        borderWidth: 2,
        tension: 0.4,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 8,
        pointBackgroundColor: '#8ab4f8',
        pointBorderColor: 'white',
        pointHoverBackgroundColor: 'white',
        pointHoverBorderColor: '#8ab4f8',
        yAxisID: 'y'
      },
      {
        label: 'Solar Voltage (V)',
        data: solarData,
        borderColor: '#f9a825',
        backgroundColor: 'rgba(249, 168, 37, 0.1)',
        borderWidth: 2,
        tension: 0.4,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 8,
        pointBackgroundColor: '#f9a825',
        pointBorderColor: 'white',
        pointHoverBackgroundColor: 'white',
        pointHoverBorderColor: '#f9a825',
        yAxisID: 'y'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
      mode: 'index',
      intersect: false,
    },
    plugins: {
      tooltip: {
        enabled: true,
        mode: 'index',
        intersect: false,
        backgroundColor: '#11182b',
        titleColor: 'white',
        bodyColor: '#ddd',
        borderColor: '#2a3a5e',
        borderWidth: 1,
        padding: 10,
        displayColors: true,
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';
            if (label) {
              label += ': ';
            }
            if (context.parsed.y !== null) {
              label += context.parsed.y.toFixed(2) + ' V';
            }
            return label;
          },
          afterLabel: function(context) {
            const pumpState = window.lastPumpState || false;
            return 'Filter Pump: ' + (pumpState ? 'RUNNING' : 'OFF');
          }
        }
      },
      legend: {
        display: false
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        max: 20,
        grid: { color: '#2a3a5e' },
        ticks: { 
          color: 'white',
          callback: function(value) {
            return value + ' V';
          }
        },
        title: {
          display: true,
          text: 'Voltage (V)',
          color: 'white'
        }
      },
      x: {
        grid: { color: '#2a3a5e' },
        ticks: { 
          color: 'white',
          maxRotation: 45,
          minRotation: 45,
          maxTicksLimit: 8
        }
      }
    }
  }
});

// Listen for data from ESP32
solarRef.on("value", (snapshot) => {
  const data = snapshot.val();
  if (!data) return;
  
  // Update battery - REMOVED PERCENT
  const batteryVoltage = data.battery_voltage || 0;
  document.getElementById("batteryValue").innerHTML = batteryVoltage.toFixed(2) + " V";
  
  // Update solar - REMOVED WATT
  const solarVoltage = data.solar_voltage || 0;
  document.getElementById("solarValue").innerHTML = solarVoltage.toFixed(2) + " V";
  
  // Solar condition (kept this as it's useful)
  let solarCondition = "Night";
  if (solarVoltage > 12) solarCondition = "â˜€ï¸ Strong";
  else if (solarVoltage > 5) solarCondition = "â›… Weak";
  else if (solarVoltage > 1) solarCondition = "ğŸŒ™ Dawn/Dusk";
  document.getElementById("solarCondition").innerHTML = solarCondition;
  
  // Update pump state
  const pumpState = data.relay_state || false;
  window.lastPumpState = pumpState;
  
  // Update pump display
  document.getElementById("relaySwitch").checked = pumpState;
  document.getElementById("relayStateDisplay").innerHTML = pumpState ? "RUNNING" : "STOPPED";
  document.getElementById("relayStateDisplay").style.color = pumpState ? "#00c853" : "#ff6b6b";
  
  // Update pump mode
  document.getElementById("pumpMode").innerHTML = data.fault_detected ? "Auto (Fault)" : "Manual";
  
  // Update pump indicator on graph
  const pumpIndicator = document.getElementById("pumpIndicator");
  const pumpIndicatorText = document.getElementById("pumpIndicatorText");
  if (pumpState) {
    pumpIndicator.style.color = "#00c853";
    pumpIndicatorText.innerHTML = "Filter RUNNING";
    pumpIndicatorText.style.color = "#00c853";
  } else {
    pumpIndicator.style.color = "#ff6b6b";
    pumpIndicatorText.innerHTML = "Filter OFF";
    pumpIndicatorText.style.color = "#ff6b6b";
  }
  
  // Track pump runtime
  if (pumpState && !lastPumpState) {
    // Pump just started
    pumpStartTime = Date.now();
    pumpCycles++;
    document.getElementById("pumpLastStart").innerHTML = new Date().toLocaleTimeString();
  } else if (!pumpState && lastPumpState && pumpStartTime) {
    // Pump just stopped
    const runtime = Math.round((Date.now() - pumpStartTime) / 60000); // minutes
    totalRuntime += runtime;
    pumpStartTime = null;
  }
  
  // Update runtime display
  if (pumpState && pumpStartTime) {
    const currentRuntime = Math.round((Date.now() - pumpStartTime) / 60000);
    document.getElementById("pumpRuntime").innerHTML = (totalRuntime + currentRuntime) + " min";
  } else {
    document.getElementById("pumpRuntime").innerHTML = totalRuntime + " min";
  }
  
  document.getElementById("pumpCycles").innerHTML = pumpCycles;
  
  lastPumpState = pumpState;
  
  // Update fault
  const faultMsg = data.fault_status || "NORMAL";
  const faultEl = document.getElementById("faultStatus");
  faultEl.innerHTML = faultMsg;
  faultEl.className = faultMsg.includes("LOW") ? "fault-LOW" : 
                     (faultMsg.includes("OVER") ? "fault-CRITICAL" : "fault-NORMAL");
  
  // Update combined chart
  const time = new Date().toLocaleTimeString();
  timeLabels.push(time);
  batteryData.push(batteryVoltage);
  solarData.push(solarVoltage);
  
  // Keep last 15 points
  if (timeLabels.length > 15) {
    timeLabels.shift();
    batteryData.shift();
    solarData.shift();
  }
  
  combinedChart.update();
});

// ===== PUMP CONTROL FUNCTIONS =====
function toggleRelay(switchEl) {
  const newState = switchEl.checked;
  setRelay(newState);
}

function setRelay(state) {
  const action = state ? "START" : "STOP";
  solarRef.update({
    relay_state: state
  }).then(() => {
    document.getElementById("commandMsg").innerHTML = "âœ“ Filter pump " + action + " command sent";
    setTimeout(() => document.getElementById("commandMsg").innerHTML = "", 2000);
  }).catch(error => {
    document.getElementById("commandMsg").innerHTML = "âœ— Error: " + error.message;
  });
}

// Note: Reset System button has been REMOVED as requested
</script>
</body>
</html>
