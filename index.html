<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ESP32 Solar Monitoring - GitHub Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* Same styling as before */
body{
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  color: #e6e6e9;
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 20px;
}

.header{
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
  padding: 20px;
  text-align: center;
  font-size: 28px;
  font-weight: bold;
  border-bottom: 2px solid #4a2f8c;
  border-radius: 10px;
  margin-bottom: 20px;
}

.section{
  background: rgba(22, 26, 35, 0.8);
  backdrop-filter: blur(8px);
  padding: 22px;
  border-radius: 20px;
  margin-bottom: 25px;
  border: 1px solid rgba(157, 123, 245, 0.2);
}

.section-title{
  color: #9d7bf5;
  font-size: 22px;
  margin-bottom: 20px;
  border-bottom: 1px solid #4a2f8c;
  padding-bottom: 10px;
}

.chart-container{
  height: 400px;
  width: 100%;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 15px;
  padding: 15px;
}

.table-container{
  width: 100%;
  overflow-x: auto;
  max-height: 500px;
  overflow-y: auto;
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.2);
}

table{
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

th{
  background: #4a2f8c;
  color: white;
  padding: 12px;
  position: sticky;
  top: 0;
}

td{
  padding: 10px;
  border-bottom: 1px solid rgba(157, 123, 245, 0.2);
}

tr:hover{
  background: rgba(157, 123, 245, 0.1);
}

.fault-badge{
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}

.badge-LOW{ background: #f9a825; color: #000; }
.badge-HIGH{ background: #ff6b6b; color: #000; }
.badge-WIRING{ background: #ff4b4b; color: white; }
.badge-DUST{ background: #ff9f4b; color: #000; }

.last-updated{
  color: #9d7bf5;
  font-size: 12px;
  margin: 10px 0;
  text-align: right;
}

.btn-refresh{
  background: #4a2f8c;
  color: white;
  border: none;
  padding: 8px 20px;
  border-radius: 20px;
  cursor: pointer;
  float: right;
  margin-top: -40px;
}

.btn-refresh:hover{
  background: #6b4fb5;
}

.stats-grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card{
  background: rgba(0, 0, 0, 0.3);
  padding: 15px;
  border-radius: 12px;
  text-align: center;
}

.stat-value{
  font-size: 24px;
  color: #9d7bf5;
  font-weight: bold;
}

.stat-label{
  font-size: 12px;
  color: #888;
}
</style>
</head>

<body>
<div class="header">
  ‚òÄÔ∏è ESP32 SOLAR MONITORING DASHBOARD ‚òÄÔ∏è
</div>

<!-- Stats Overview -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-value" id="avgBattery">--</div>
    <div class="stat-label">Avg Battery Voltage</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="avgSolar">--</div>
    <div class="stat-label">Avg Solar Voltage</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="totalFaults">--</div>
    <div class="stat-label">Total Faults</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="lastUpdate">--</div>
    <div class="stat-label">Last Update</div>
  </div>
</div>

<!-- SECTION 1: Voltage History Graph (Last 50 Readings) -->
<div class="section">
  <div class="section-title">üìà VOLTAGE HISTORY (LAST 50 READINGS)</div>
  <button class="btn-refresh" onclick="refreshAll()">‚Üª Refresh</button>
  <div class="last-updated" id="graphUpdated"></div>
  <div class="chart-container">
    <canvas id="voltageChart"></canvas>
  </div>
  <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px;">
    <div><span style="color: #9d7bf5;">‚óè</span> Battery Voltage</div>
    <div><span style="color: #f9a825;">‚óè</span> Solar Voltage</div>
  </div>
</div>

<!-- SECTION 2: Fault History Table -->
<div class="section">
  <div class="section-title">‚ö†Ô∏è FAULT HISTORY LOG</div>
  <div class="last-updated" id="faultUpdated"></div>
  <div class="table-container">
    <table id="faultTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Fault Type</th>
          <th>Value</th>
          <th>Message</th>
          <th>Device</th>
        </tr>
      </thead>
      <tbody id="faultTableBody">
        <tr><td colspan="5" style="text-align:center;">Loading fault data...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
// ============= CONFIGURATION =============
// Replace these with your actual Google Sheets CSV URLs
const VOLTAGE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS2XBzdxcKafuTJT8c_7Ec8vj_TjuxRF6J2UsXA8phw-BmC0g7eFZpcuAs_dvLUyhDBh031I8VXzDw-/pub?gid=1113512589&single=true&output=csv";
const FAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS2XBzdxcKafuTJT8c_7Ec8vj_TjuxRF6J2UsXA8phw-BmC0g7eFZpcuAs_dvLUyhDBh031I8VXzDw-/pub?gid=0&single=true&output=csv";

// Chart instance
let voltageChart;

// ============= INITIALIZE CHART =============
function initChart() {
  const ctx = document.getElementById('voltageChart').getContext('2d');
  voltageChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Battery Voltage (V)',
          data: [],
          borderColor: '#9d7bf5',
          backgroundColor: 'rgba(157, 123, 245, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          pointRadius: 3
        },
        {
          label: 'Solar Voltage (V)',
          data: [],
          borderColor: '#f9a825',
          backgroundColor: 'rgba(249, 168, 37, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 20,
          grid: { color: 'rgba(157, 123, 245, 0.1)' },
          ticks: { color: 'white' }
        },
        x: {
          grid: { color: 'rgba(157, 123, 245, 0.1)' },
          ticks: { color: 'white', maxRotation: 45 }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// ============= LOAD VOLTAGE DATA =============
async function loadVoltageData() {
  try {
    const response = await fetch(VOLTAGE_CSV_URL);
    const csvData = await response.text();
    
    Papa.parse(csvData, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        updateChart(results.data);
        
        // Calculate averages
        let batterySum = 0, solarSum = 0, count = 0;
        results.data.forEach(row => {
          if (row['Battery Voltage'] && row['Solar Voltage']) {
            batterySum += parseFloat(row['Battery Voltage']) || 0;
            solarSum += parseFloat(row['Solar Voltage']) || 0;
            count++;
          }
        });
        
        if (count > 0) {
          document.getElementById('avgBattery').innerHTML = (batterySum/count).toFixed(2) + 'V';
          document.getElementById('avgSolar').innerHTML = (solarSum/count).toFixed(2) + 'V';
        }
        
        document.getElementById('graphUpdated').innerHTML = 'Updated: ' + new Date().toLocaleTimeString();
      }
    });
  } catch (error) {
    console.error('Error loading voltage data:', error);
  }
}

// ============= UPDATE CHART =============
function updateChart(data) {
  const labels = [];
  const batteryData = [];
  const solarData = [];
  
  // Get last 50 readings
  const last50 = data.slice(-50);
  
  last50.forEach(row => {
    if (row['Timestamp']) {
      labels.push(new Date(row['Timestamp']).toLocaleTimeString());
      batteryData.push(parseFloat(row['Battery Voltage']) || 0);
      solarData.push(parseFloat(row['Solar Voltage']) || 0);
    }
  });
  
  voltageChart.data.labels = labels;
  voltageChart.data.datasets[0].data = batteryData;
  voltageChart.data.datasets[1].data = solarData;
  voltageChart.update();
}

// ============= LOAD FAULT DATA =============
async function loadFaultData() {
  try {
    const response = await fetch(FAULT_CSV_URL);
    const csvData = await response.text();
    
    Papa.parse(csvData, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        displayFaults(results.data);
        document.getElementById('totalFaults').innerHTML = results.data.length;
        document.getElementById('faultUpdated').innerHTML = 'Updated: ' + new Date().toLocaleTimeString();
        document.getElementById('lastUpdate').innerHTML = new Date().toLocaleTimeString();
      }
    });
  } catch (error) {
    console.error('Error loading fault data:', error);
  }
}

// ============= DISPLAY FAULTS =============
function displayFaults(rows) {
  const tbody = document.getElementById('faultTableBody');
  
  if (!rows || rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No fault data</td></tr>';
    return;
  }
  
  // Filter valid rows and reverse (newest first)
  const validRows = rows.filter(row => row.Timestamp && row['Fault Type']).reverse();
  
  let html = '';
  validRows.slice(0, 50).forEach(row => {
    let badgeClass = 'badge-';
    const faultType = row['Fault Type'] || '';
    
    if (faultType.includes('LOW')) badgeClass += 'LOW';
    else if (faultType.includes('HIGH')) badgeClass += 'HIGH';
    else if (faultType.includes('WIRING')) badgeClass += 'WIRING';
    else if (faultType.includes('DUST')) badgeClass += 'DUST';
    else badgeClass += 'LOW';
    
    html += `<tr>
      <td>${row.Timestamp || '--'}</td>
      <td><span class="fault-badge ${badgeClass}">${faultType}</span></td>
      <td>${row['Value (V)'] || '--'}</td>
      <td>${row.Message || '--'}</td>
      <td>${row['Device ID'] || 'ESP32'}</td>
    </tr>`;
  });
  
  tbody.innerHTML = html;
}

// ============= REFRESH ALL =============
function refreshAll() {
  loadVoltageData();
  loadFaultData();
}

// ============= AUTO REFRESH =============
// Initial load
initChart();
loadVoltageData();
loadFaultData();

// Refresh every 5 minutes
setInterval(refreshAll, 300000);
</script>
</body>
</html>
