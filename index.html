<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ESP32 Solar Monitoring Console</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
background:#0b0f1a;
color:white;
font-family:Segoe UI;
margin:0;
}

.header{
background:#11182b;
padding:18px;
text-align:center;
font-size:26px;
font-weight:bold;
border-bottom:2px solid #2a3a5e;
}

.status{
text-align:center;
padding:6px;
background:#7a1d1d;
font-size:13px;
font-weight:bold;
}

.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
gap:20px;
padding:20px;
}

.card{
background:#151c30;
padding:20px;
border-radius:14px;
box-shadow:0 5px 25px rgba(0,0,0,0.6);
border:1px solid #2a3a5e;
}

.big{
font-size:34px;
margin:10px 0;
font-weight:bold;
color:#8ab4f8;
}

.fault-badge{
display:inline-block;
padding:8px 16px;
border-radius:20px;
font-weight:bold;
margin-top:10px;
}

.fault-NORMAL{
background:#0a7e3a;
color:white;
}

.fault-LOW{
background:#b95b0d;
color:white;
}

.fault-CRITICAL{
background:#7a1d1d;
color:white;
}

canvas{
width:100% !important;
height:300px !important;
background:#1e2740;
border-radius:10px;
padding:10px;
}

/* Toggle Switch */
.switch{
position:relative;
display:inline-block;
width:70px;
height:36px;
}

.switch input{
display:none;
}

.slider{
position:absolute;
cursor:pointer;
top:0; left:0; right:0; bottom:0;
background:#888;
border-radius:34px;
transition:.3s;
}

.slider:before{
position:absolute;
content:"";
height:28px;
width:28px;
left:4px;
bottom:4px;
background:white;
border-radius:50%;
transition:.3s;
}

input:checked + .slider{
background:#00c853;
box-shadow:0 0 12px #00ff80;
}

input:checked + .slider:before{
transform:translateX(34px);
}

.value-row{
display:flex;
justify-content:space-between;
margin:10px 0;
padding:8px;
background:#1e2740;
border-radius:8px;
}

.signal-strength{
display:inline-block;
width:100px;
height:8px;
background:#2a3a5e;
border-radius:4px;
margin-left:10px;
}

.signal-fill{
height:8px;
background:#00c853;
border-radius:4px;
}

.control-group{
margin-top:15px;
padding:10px;
background:#1e2740;
border-radius:8px;
}

.btn{
background:#2a3a5e;
color:white;
border:none;
padding:8px 16px;
border-radius:6px;
cursor:pointer;
margin-right:10px;
font-weight:bold;
}

.btn:hover{
background:#3a4a7e;
}

.btn-reset{
background:#b95b0d;
}

.btn-reset:hover{
background:#d97b2d;
}

</style>
</head>

<body>

<div class="header">ğŸ”‹ ESP32 Solar Monitoring System</div>
<div id="statusBar" class="status">CONNECTING...</div>

<div class="grid">

<!-- Relay Control Card -->
<div class="card">
<h3>âš¡ Relay Control</h3>
<div class="value-row">
<span>Manual Control:</span>
<label class="switch">
<input type="checkbox" id="relaySwitch" onchange="toggleRelay(this)">
<span class="slider"></span>
</label>
</div>
<div class="value-row">
<span>Current State:</span>
<span id="relayStateDisplay">OFF</span>
</div>
<div class="control-group">
<button class="btn" onclick="sendRemoteCommand(true)">Turn ON</button>
<button class="btn" onclick="sendRemoteCommand(false)">Turn OFF</button>
<button class="btn btn-reset" onclick="sendResetCommand()">RESET SYSTEM</button>
</div>
</div>

<!-- Battery Voltage Card -->
<div class="card">
<h3>ğŸ”‹ Battery Voltage</h3>
<div id="bat" class="big">--.-- V</div>
<div class="value-row">
<span>Level:</span>
<span id="batPercent">--%</span>
</div>
<div id="batStatus" class="fault-badge fault-NORMAL">NORMAL</div>
</div>

<!-- Solar Voltage Card -->
<div class="card">
<h3>â˜€ï¸ Solar Voltage</h3>
<div id="sol" class="big">--.-- V</div>
<div class="value-row">
<span>Status:</span>
<span id="solarStatus">--</span>
</div>
</div>

<!-- System Status Card -->
<div class="card">
<h3>ğŸ“Š System Status</h3>
<div class="value-row">
<span>Fault Status:</span>
<span id="faultMessage">NORMAL</span>
</div>
<div class="value-row">
<span>Fault Detected:</span>
<span id="faultDetected">No</span>
</div>
<div class="value-row">
<span>WiFi Signal:</span>
<span id="wifiSignal">-- dBm</span>
</div>
<div class="value-row">
<span>Signal Strength:</span>
<div class="signal-strength">
<div id="signalFill" class="signal-fill" style="width:0%"></div>
</div>
</div>
<div class="value-row">
<span>Last Update:</span>
<span id="timestamp">--</span>
</div>
</div>

<!-- Battery Gauge -->
<div class="card">
<h3>ğŸ”‹ Battery Gauge</h3>
<canvas id="batGauge"></canvas>
<div style="text-align:center; margin-top:10px;" id="batGaugeLabel">0%</div>
</div>

<!-- Solar Gauge -->
<div class="card">
<h3>â˜€ï¸ Solar Gauge</h3>
<canvas id="solGauge"></canvas>
<div style="text-align:center; margin-top:10px;" id="solGaugeLabel">0V</div>
</div>

<!-- Battery History -->
<div class="card">
<h3>ğŸ“ˆ Battery History (12V range)</h3>
<canvas id="batChart"></canvas>
</div>

<!-- Solar History -->
<div class="card">
<h3>ğŸ“ˆ Solar History (15V range)</h3>
<canvas id="solChart"></canvas>
</div>

<!-- Raw Data Viewer -->
<div class="card">
<h3>ğŸ“‹ Live Data Stream</h3>
<pre id="rawData" style="background:#1e2740; padding:10px; border-radius:8px; overflow-x:auto; font-size:12px;">Waiting for data...</pre>
</div>

</div>

<script>
// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "AIzaSyCkmuTiwSxHQ6_gKjpqYS357MlCLM9rp1k",
  authDomain: "solar-fault-detection-ecf01.firebaseapp.com",
  databaseURL: "https://solar-fault-detection-ecf01-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "solar-fault-detection-ecf01",
  storageBucket: "solar-fault-detection-ecf01.firebasestorage.app",
  messagingSenderId: "370792337840",
  appId: "1:370792337840:web:9619f4b0be5c435f750675"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Reference to the solar_system node (SINGLE FOLDER)
const solarRef = database.ref("solar_system");

// ================= CONNECTION STATUS =================
database.ref(".info/connected").on("value", snap => {
  let el = document.getElementById("statusBar");
  if (snap.val()) {
    el.style.background = "#0a7e3a";
    el.innerHTML = "âœ… CONNECTED TO FIREBASE";
  } else {
    el.style.background = "#7a1d1d";
    el.innerHTML = "âŒ DISCONNECTED - CHECK NETWORK";
  }
});

// ================= CHARTS =================
const batChart = new Chart(document.getElementById("batChart"), {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Battery Voltage (V)',
      data: [],
      borderColor: '#8ab4f8',
      backgroundColor: 'rgba(138, 180, 248, 0.1)',
      borderWidth: 2,
      tension: 0.4,
      fill: true
    }]
  },
  options: {
    animation: false,
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        max: 15,
        grid: { color: '#2a3a5e' },
        ticks: { color: 'white' }
      },
      x: {
        grid: { color: '#2a3a5e' },
        ticks: { color: 'white', maxRotation: 45, minRotation: 45 }
      }
    },
    plugins: {
      legend: { labels: { color: 'white' } }
    }
  }
});

const solChart = new Chart(document.getElementById("solChart"), {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Solar Voltage (V)',
      data: [],
      borderColor: '#f9a825',
      backgroundColor: 'rgba(249, 168, 37, 0.1)',
      borderWidth: 2,
      tension: 0.4,
      fill: true
    }]
  },
  options: {
    animation: false,
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        max: 20,
        grid: { color: '#2a3a5e' },
        ticks: { color: 'white' }
      },
      x: {
        grid: { color: '#2a3a5e' },
        ticks: { color: 'white', maxRotation: 45, minRotation: 45 }
      }
    },
    plugins: {
      legend: { labels: { color: 'white' } }
    }
  }
});

// ================= GAUGES =================
function createGauge(id, maxValue, color) {
  return new Chart(document.getElementById(id), {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [0, maxValue],
        backgroundColor: [color, '#2a3a5e'],
        borderWidth: 0,
        cutout: '75%'
      }]
    },
    options: {
      rotation: -90,
      circumference: 180,
      plugins: { legend: { display: false } },
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

const batGauge = createGauge("batGauge", 15, '#8ab4f8');
const solGauge = createGauge("solGauge", 20, '#f9a825');

// ================= BATTERY PERCENTAGE CALCULATION =================
function calculateBatteryPercent(voltage) {
  // For 12V lead-acid battery: 11.5V = 0%, 12.6V = 100%
  const min = 11.0;
  const max = 12.6;
  let percent = ((voltage - min) / (max - min)) * 100;
  return Math.min(100, Math.max(0, percent)).toFixed(0);
}

// ================= FAULT BADGE STYLING =================
function getFaultClass(faultMsg) {
  if (faultMsg.includes("LOW")) return "fault-LOW";
  if (faultMsg.includes("OVER") || faultMsg.includes("FAULT")) return "fault-CRITICAL";
  return "fault-NORMAL";
}

// ================= SIGNAL STRENGTH CONVERSION =================
function getSignalPercent(rssi) {
  // RSSI range: -30 (excellent) to -90 (poor)
  let percent = Math.min(100, Math.max(0, ((rssi + 90) / 60) * 100));
  return percent;
}

// ================= TIMESTAMP FORMATTING =================
function formatTimestamp(ms) {
  if (!ms) return "--";
  let date = new Date(ms);
  return date.toLocaleTimeString() + ' ' + date.toLocaleDateString();
}

// Keep history arrays
let batHistory = [];
let solHistory = [];
let timeHistory = [];
const MAX_HISTORY = 20;

// ================= LIVE DATA UPDATE =================
solarRef.on("value", snap => {
  const data = snap.val();
  if (!data) {
    document.getElementById("rawData").innerHTML = "âš ï¸ No data available yet...";
    return;
  }

  // Display raw data for debugging
  document.getElementById("rawData").innerHTML = JSON.stringify(data, null, 2);

  // Extract values from the single solar_system node
  const batteryVoltage = parseFloat(data.battery_voltage) || 0;
  const solarVoltage = parseFloat(data.solar_voltage) || 0;
  const relayState = data.relay_state || false;
  const faultMsg = data.fault_status || "NORMAL";
  const faultDetected = data.fault_detected || false;
  const wifiRSSI = parseInt(data.wifi_signal) || -70;
  const timestamp = data.timestamp || 0;

  // Update displays
  document.getElementById("bat").innerHTML = batteryVoltage.toFixed(2) + " V";
  document.getElementById("sol").innerHTML = solarVoltage.toFixed(2) + " V";
  
  const batteryPercent = calculateBatteryPercent(batteryVoltage);
  document.getElementById("batPercent").innerHTML = batteryPercent + "%";
  
  // Relay display
  document.getElementById("relaySwitch").checked = relayState;
  document.getElementById("relayStateDisplay").innerHTML = relayState ? "ON" : "OFF";
  document.getElementById("relayStateDisplay").style.color = relayState ? "#00c853" : "#ff6b6b";
  
  // Fault display
  document.getElementById("faultMessage").innerHTML = faultMsg;
  document.getElementById("faultDetected").innerHTML = faultDetected ? "YES âš ï¸" : "No âœ“";
  
  // Apply fault badge styling
  const faultBadge = document.getElementById("batStatus");
  faultBadge.innerHTML = faultMsg;
  faultBadge.className = "fault-badge " + getFaultClass(faultMsg);
  
  // Solar status
  let solarStatus = solarVoltage > 5 ? "ACTIVE" : (solarVoltage > 1 ? "LOW" : "NIGHT");
  document.getElementById("solarStatus").innerHTML = solarStatus;
  document.getElementById("solarStatus").style.color = solarStatus === "ACTIVE" ? "#00c853" : (solarStatus === "LOW" ? "#f9a825" : "#888");
  
  // WiFi signal
  document.getElementById("wifiSignal").innerHTML = wifiRSSI + " dBm";
  const signalPercent = getSignalPercent(wifiRSSI);
  document.getElementById("signalFill").style.width = signalPercent + "%";
  
  // Timestamp
  document.getElementById("timestamp").innerHTML = formatTimestamp(timestamp);

  // Update gauges
  batGauge.data.datasets[0].data = [batteryVoltage, 15 - batteryVoltage];
  batGauge.update('none');
  document.getElementById("batGaugeLabel").innerHTML = batteryPercent + "%";
  
  solGauge.data.datasets[0].data = [solarVoltage, 20 - solarVoltage];
  solGauge.update('none');
  document.getElementById("solGaugeLabel").innerHTML = solarVoltage.toFixed(1) + "V";

  // Update history charts (keep last 20 readings)
  const timeLabel = new Date(timestamp).toLocaleTimeString();
  
  batHistory.push(batteryVoltage);
  solHistory.push(solarVoltage);
  timeHistory.push(timeLabel);
  
  if (batHistory.length > MAX_HISTORY) batHistory.shift();
  if (solHistory.length > MAX_HISTORY) solHistory.shift();
  if (timeHistory.length > MAX_HISTORY) timeHistory.shift();
  
  batChart.data.labels = timeHistory;
  batChart.data.datasets[0].data = batHistory;
  batChart.update('none');
  
  solChart.data.labels = timeHistory;
  solChart.data.datasets[0].data = solHistory;
  solChart.update('none');
});

// ================= RELAY CONTROL FUNCTIONS =================
function toggleRelay(sw) {
  // Direct relay control
  solarRef.update({
    relay_state: sw.checked
  });
  
  // Also set remote_relay for consistency
  solarRef.update({
    remote_relay: sw.checked
  });
}

function sendRemoteCommand(state) {
  solarRef.update({
    remote_relay: state
  });
  
  // Update switch UI
  document.getElementById("relaySwitch").checked = state;
  
  // Show feedback
  alert(`Remote command sent: Turn relay ${state ? 'ON' : 'OFF'}`);
}

function sendResetCommand() {
  if (confirm("Are you sure you want to reset the system?")) {
    solarRef.update({
      reset: true
    });
    
    // Also turn relay off
    solarRef.update({
      relay_state: false,
      remote_relay: false
    });
    
    document.getElementById("relaySwitch").checked = false;
    alert("Reset command sent!");
  }
}

// ================= INITIAL SETUP =================
// Create the structure if it doesn't exist
solarRef.once("value", snap => {
  if (!snap.exists()) {
    solarRef.set({
      battery_voltage: 0,
      solar_voltage: 0,
      relay_state: false,
      fault_status: "NORMAL",
      fault_detected: false,
      wifi_signal: -70,
      timestamp: Date.now(),
      remote_relay: false,
      reset: false
    });
  }
});

</script>
</body>
</html>
