<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ESP32 Solar Water Filtering System</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* NEW THEME - Dark Blue/Purple Theme */
body{
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  color: #e6e6e9;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  min-height: 100vh;
}

.header{
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
  padding: 20px;
  text-align: center;
  font-size: 28px;
  font-weight: bold;
  border-bottom: 2px solid #4a2f8c;
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  letter-spacing: 1px;
}

.header span{
  color: #9d7bf5;
  margin: 0 10px;
}

.status{
  text-align: center;
  padding: 8px;
  background: #2a1b4b;
  font-size: 14px;
  font-weight: 500;
  border-bottom: 1px solid #4a2f8c;
}

.grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 22px;
  padding: 25px;
  max-width: 1400px;
  margin: 0 auto;
}

.card{
  background: rgba(22, 26, 35, 0.8);
  backdrop-filter: blur(8px);
  padding: 22px;
  border-radius: 20px;
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(157, 123, 245, 0.2);
  transition: transform 0.2s;
}

.card:hover{
  transform: translateY(-5px);
  border-color: rgba(157, 123, 245, 0.5);
}

.big{
  font-size: 38px;
  margin: 15px 0;
  font-weight: bold;
  background: linear-gradient(135deg, #9d7bf5, #6b4fb5);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.value-row{
  display: flex;
  justify-content: space-between;
  margin: 12px 0;
  padding: 10px 15px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Toggle Switch - Updated Colors */
.switch{
  position: relative;
  display: inline-block;
  width: 70px;
  height: 36px;
}

.switch input{
  display: none;
}

.slider{
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #3a2a5a;
  border-radius: 34px;
  transition: .3s;
  border: 1px solid #6b4fb5;
}

.slider:before{
  position: absolute;
  content: "";
  height: 28px;
  width: 28px;
  left: 4px;
  bottom: 4px;
  background: #9d7bf5;
  border-radius: 50%;
  transition: .3s;
}

input:checked + .slider{
  background: #4a2f8c;
}

input:checked + .slider:before{
  transform: translateX(34px);
  background: #c3a9ff;
}

/* Buttons - Updated Theme */
.btn{
  background: linear-gradient(135deg, #4a2f8c, #2a1b4b);
  color: white;
  border: 1px solid #6b4fb5;
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  margin-right: 10px;
  font-weight: bold;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.btn:hover{
  background: linear-gradient(135deg, #5b3f9c, #3a2b5b);
  transform: scale(1.02);
  border-color: #9d7bf5;
}

.btn-off{
  background: linear-gradient(135deg, #4a2a3a, #2a1a2a);
  border-color: #a55f7b;
}

.btn-off:hover{
  background: linear-gradient(135deg, #5a3a4a, #3a2a3a);
}

/* Fault States */
.fault-NORMAL{
  color: #9d7bf5;
  font-weight: bold;
  font-size: 18px;
  text-shadow: 0 0 10px rgba(157, 123, 245, 0.3);
}

.fault-LOW{
  color: #f9a825;
  font-weight: bold;
  font-size: 18px;
  text-shadow: 0 0 10px rgba(249, 168, 37, 0.3);
}

.fault-CRITICAL{
  color: #ff6b6b;
  font-weight: bold;
  font-size: 18px;
  text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
}

/* Chart Container */
.chart-container{
  position: relative;
  height: 300px;
  width: 100%;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 15px;
  padding: 15px;
  border: 1px solid rgba(157, 123, 245, 0.2);
}

/* Icons */
.pump-icon, .water-icon{
  font-size: 24px;
  margin-right: 10px;
  vertical-align: middle;
  filter: drop-shadow(0 0 8px #9d7bf5);
}

/* History Note */
.history-note{
  text-align: center;
  font-size: 12px;
  color: #9d7bf5;
  margin-top: 10px;
  opacity: 0.8;
}
</style>
</head>

<body>
<div class="header">
  <span>üíß</span> ESP32 SOLAR WATER FILTERING <span>üåä</span>
</div>
<div id="statusBar" class="status">CONNECTING TO SYSTEM...</div>

<div class="grid">
  <!-- Filter Pump Control Card -->
  <div class="card">
    <h3><span class="pump-icon">‚õ≤</span> Filter Pump Control</h3>
    <div class="value-row">
      <span><span class="water-icon">üíß</span> Pump Switch:</span>
      <label class="switch">
        <input type="checkbox" id="relaySwitch" onchange="toggleRelay(this)">
        <span class="slider"></span>
      </label>
    </div>
    <div class="value-row">
      <span><span class="water-icon">‚ö°</span> Pump Status:</span>
      <span id="relayStateDisplay" style="font-weight:bold; color:#9d7bf5;">OFF</span>
    </div>
    <div class="value-row" style="justify-content: center; gap: 15px;">
      <button class="btn" onclick="setRelay(true)">üíß START FILTER</button>
      <button class="btn btn-off" onclick="setRelay(false)">‚èπÔ∏è STOP FILTER</button>
    </div>
    <div id="commandMsg" style="color:#9d7bf5; font-size:12px; margin-top:5px; text-align:center;"></div>
  </div>

  <!-- Battery Card -->
  <div class="card">
    <h3>üîã Battery Voltage</h3>
    <div id="batteryValue" class="big">--.-- V</div>
    <div id="faultStatus" class="fault-NORMAL">NORMAL</div>
  </div>

  <!-- Solar Card -->
  <div class="card">
    <h3>‚òÄÔ∏è Solar Panel Voltage</h3>
    <div id="solarValue" class="big">--.-- V</div>
    <div id="solarCondition">--</div>
  </div>

  <!-- Pump Status Card -->
  <div class="card">
    <h3>‚õ≤ Filter Pump Information</h3>
    <div class="value-row">
      <span><span class="water-icon">‚è±Ô∏è</span> Runtime Today:</span>
      <span id="pumpRuntime">0 min</span>
    </div>
    <div class="value-row">
      <span><span class="water-icon">üîÑ</span> Cycles Today:</span>
      <span id="pumpCycles">0</span>
    </div>
    <div class="value-row">
      <span><span class="water-icon">‚è∞</span> Last Started:</span>
      <span id="pumpLastStart">--:--</span>
    </div>
  </div>

  <!-- COMBINED GRAPH with History Fix -->
  <div class="card" style="grid-column: 1 / -1;">
    <h3>üìä System Performance History</h3>
    <div class="chart-container">
      <canvas id="combinedChart"></canvas>
    </div>
    <div style="display:flex; justify-content:center; gap:30px; margin-top:15px;">
      <div><span style="color:#9d7bf5;">‚óè</span> Battery Voltage (V)</div>
      <div><span style="color:#f9a825;">‚óè</span> Solar Voltage (V)</div>
      <div><span style="color:#00c853;" id="pumpIndicator">‚óè</span> <span id="pumpIndicatorText">Filter OFF</span></div>
    </div>
    <div class="history-note">‚ö†Ô∏è Note: History is stored in browser memory only</div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCkmuTiwSxHQ6_gKjpqYS357MlCLM9rp1k",
  authDomain: "solar-fault-detection-ecf01.firebaseapp.com",
  databaseURL: "https://solar-fault-detection-ecf01-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "solar-fault-detection-ecf01",
  storageBucket: "solar-fault-detection-ecf01.firebasestorage.app",
  messagingSenderId: "370792337840",
  appId: "1:370792337840:web:9619f4b0be5c435f750675"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const solarRef = db.ref("solar_system");

// WHY FIREBASE CAN'T SAVE HISTORY:
// Firebase Realtime Database is NOT a time-series database
// It's designed for real-time sync, not historical data storage
// The data gets overwritten each time ESP32 uploads

// SOLUTION: Create a history node in Firebase
// Uncomment this section to enable Firebase history
/*
function saveHistoryToFirebase(batteryV, solarV, pumpState) {
  const historyRef = db.ref("solar_system/history").push();
  historyRef.set({
    timestamp: firebase.database.ServerValue.TIMESTAMP,
    battery: batteryV,
    solar: solarV,
    pump: pumpState,
    time: new Date().toLocaleTimeString()
  });
}
*/

// Pump tracking
let pumpStartTime = null;
let totalRuntime = 0;
let pumpCycles = 0;
let lastPumpState = false;

// Connection status
db.ref(".info/connected").on("value", (snap) => {
  const statusEl = document.getElementById("statusBar");
  if (snap.val()) {
    statusEl.innerHTML = "‚úÖ CONNECTED TO SYSTEM";
    statusEl.style.background = "#2a1b4b";
  } else {
    statusEl.innerHTML = "‚ùå DISCONNECTED";
    statusEl.style.background = "#4a2a3a";
  }
});

// Chart with localStorage persistence
let timeLabels = [];
let batteryData = [];
let solarData = [];

// Load saved history from localStorage (browser memory)
function loadHistory() {
  try {
    const saved = localStorage.getItem('solarHistory');
    if (saved) {
      const history = JSON.parse(saved);
      timeLabels = history.timeLabels || [];
      batteryData = history.batteryData || [];
      solarData = history.solarData || [];
    }
  } catch (e) {
    console.log('No saved history');
  }
}

// Save history to localStorage
function saveHistory() {
  try {
    localStorage.setItem('solarHistory', JSON.stringify({
      timeLabels,
      batteryData,
      solarData
    }));
  } catch (e) {
    console.log('Could not save history');
  }
}

// Load history on startup
loadHistory();

const ctx = document.getElementById("combinedChart").getContext("2d");

const combinedChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: timeLabels,
    datasets: [
      {
        label: 'Battery Voltage (V)',
        data: batteryData,
        borderColor: '#9d7bf5',
        backgroundColor: 'rgba(157, 123, 245, 0.1)',
        borderWidth: 3,
        tension: 0.3,
        fill: false,
        pointRadius: 5,
        pointHoverRadius: 10,
        pointBackgroundColor: '#9d7bf5',
        pointBorderColor: 'white',
        pointHoverBackgroundColor: 'white',
        pointHoverBorderColor: '#9d7bf5',
        yAxisID: 'y'
      },
      {
        label: 'Solar Voltage (V)',
        data: solarData,
        borderColor: '#f9a825',
        backgroundColor: 'rgba(249, 168, 37, 0.1)',
        borderWidth: 3,
        tension: 0.3,
        fill: false,
        pointRadius: 5,
        pointHoverRadius: 10,
        pointBackgroundColor: '#f9a825',
        pointBorderColor: 'white',
        pointHoverBackgroundColor: 'white',
        pointHoverBorderColor: '#f9a825',
        yAxisID: 'y'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      tooltip: {
        enabled: true,
        backgroundColor: '#1a1a2e',
        titleColor: '#9d7bf5',
        bodyColor: 'white',
        borderColor: '#9d7bf5',
        borderWidth: 2,
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';
            return label + ': ' + context.parsed.y.toFixed(2) + ' V';
          }
        }
      },
      legend: { display: false }
    },
    scales: {
      y: {
        beginAtZero: true,
        max: 20,
        grid: { color: 'rgba(157, 123, 245, 0.1)' },
        ticks: { color: 'white' }
      },
      x: {
        grid: { color: 'rgba(157, 123, 245, 0.1)' },
        ticks: { color: 'white', maxRotation: 45 }
      }
    }
  }
});

// Listen for data
solarRef.on("value", (snapshot) => {
  const data = snapshot.val();
  if (!data) return;
  
  // Update battery
  const batteryVoltage = data.battery_voltage || 0;
  document.getElementById("batteryValue").innerHTML = batteryVoltage.toFixed(2) + " V";
  
  // Update solar
  const solarVoltage = data.solar_voltage || 0;
  document.getElementById("solarValue").innerHTML = solarVoltage.toFixed(2) + " V";
  
  // Solar condition
  let solarCondition = "Night";
  if (solarVoltage > 12) solarCondition = "‚òÄÔ∏è Strong";
  else if (solarVoltage > 5) solarCondition = "‚õÖ Weak";
  else if (solarVoltage > 1) solarCondition = "üåô Dawn/Dusk";
  document.getElementById("solarCondition").innerHTML = solarCondition;
  
  // Update pump state
  const pumpState = data.relay_state || false;
  
  // Update pump display
  document.getElementById("relaySwitch").checked = pumpState;
  document.getElementById("relayStateDisplay").innerHTML = pumpState ? "RUNNING" : "STOPPED";
  document.getElementById("relayStateDisplay").style.color = pumpState ? "#9d7bf5" : "#ff6b6b";
  
  // Update pump indicator
  const pumpIndicator = document.getElementById("pumpIndicator");
  const pumpIndicatorText = document.getElementById("pumpIndicatorText");
  if (pumpState) {
    pumpIndicator.style.color = "#9d7bf5";
    pumpIndicatorText.innerHTML = "Filter RUNNING";
    pumpIndicatorText.style.color = "#9d7bf5";
  } else {
    pumpIndicator.style.color = "#ff6b6b";
    pumpIndicatorText.innerHTML = "Filter OFF";
    pumpIndicatorText.style.color = "#ff6b6b";
  }
  
  // Track pump runtime
  if (pumpState && !lastPumpState) {
    pumpStartTime = Date.now();
    pumpCycles++;
    document.getElementById("pumpLastStart").innerHTML = new Date().toLocaleTimeString();
  } else if (!pumpState && lastPumpState && pumpStartTime) {
    const runtime = Math.round((Date.now() - pumpStartTime) / 60000);
    totalRuntime += runtime;
    pumpStartTime = null;
  }
  
  // Update runtime
  if (pumpState && pumpStartTime) {
    const currentRuntime = Math.round((Date.now() - pumpStartTime) / 60000);
    document.getElementById("pumpRuntime").innerHTML = (totalRuntime + currentRuntime) + " min";
  } else {
    document.getElementById("pumpRuntime").innerHTML = totalRuntime + " min";
  }
  
  document.getElementById("pumpCycles").innerHTML = pumpCycles;
  lastPumpState = pumpState;
  
  // Update fault
  const faultMsg = data.fault_status || "NORMAL";
  const faultEl = document.getElementById("faultStatus");
  faultEl.innerHTML = faultMsg;
  faultEl.className = faultMsg.includes("LOW") ? "fault-LOW" : 
                     (faultMsg.includes("OVER") ? "fault-CRITICAL" : "fault-NORMAL");
  
  // Add to history
  const time = new Date().toLocaleTimeString();
  timeLabels.push(time);
  batteryData.push(batteryVoltage);
  solarData.push(solarVoltage);
  
  // Keep last 20 points
  if (timeLabels.length > 20) {
    timeLabels.shift();
    batteryData.shift();
    solarData.shift();
  }
  
  // Save to localStorage
  saveHistory();
  
  combinedChart.update();
});

// Pump control functions
function toggleRelay(switchEl) {
  setRelay(switchEl.checked);
}

function setRelay(state) {
  solarRef.update({ relay_state: state })
    .then(() => {
      document.getElementById("commandMsg").innerHTML = "‚úì Filter " + (state ? "STARTED" : "STOPPED");
      setTimeout(() => document.getElementById("commandMsg").innerHTML = "", 2000);
    });
}
</script>
</body>
</html>
